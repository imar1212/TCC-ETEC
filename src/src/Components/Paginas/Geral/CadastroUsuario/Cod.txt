import React, { useState } from 'react';
import { createUser, checkEmail, checkNametag } from '../../../services/api';
import './CadastroUsuario.css';

const fotosPreDefinidas = [
  '/avatar1.png',
  '/avatar2.png',
  '/avatar3.png',
  '/avatar4.png',
  '/nenhuma.png'
];

const CadastroUsuario = () => {
  const [formData, setFormData] = useState({
    apelido: '',
    email: '',
    senha: '',
    confirmarSenha: '',
    tipo: 'usuario',
    status: 'ativo',
    foto: '/nenhuma.png',
    nametag: '',
    bio: '',
    pronomes: []
  });

  const [pronomeInput, setPronomeInput] = useState('');
  const [mensagem, setMensagem] = useState('');
  const [erro, setErro] = useState('');
  const [campoErros, setCampoErros] = useState({});
  const [step, setStep] = useState(1);
  const [previewFoto, setPreviewFoto] = useState('/nenhuma.png');

  // Controle do modal de fotos
  const [showModalFotos, setShowModalFotos] = useState(false);

  const pronomesOptions = ['Ela/dela', 'Ele/dele', 'Elu/delu'];

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
    setCampoErros(prev => ({ ...prev, [name]: '' }));
  };

  const handlePronomeSelect = (e) => {
    setPronomeInput(e.target.value);
    setCampoErros(prev => ({ ...prev, pronomes: '' }));
  };

  const handleAddPronome = () => {
    if (pronomeInput.trim() && !formData.pronomes.includes(pronomeInput.trim())) {
      setFormData(prev => ({ ...prev, pronomes: [...prev.pronomes, pronomeInput.trim()] }));
      setPronomeInput('');
    }
  };

  const handleRemovePronome = (pronome) => {
    setFormData(prev => ({
      ...prev,
      pronomes: prev.pronomes.filter(p => p !== pronome)
    }));
  };

  const abrirModalFotos = () => {
    setShowModalFotos(true);
  };

  const fecharModalFotos = () => {
    setShowModalFotos(false);
  };

  const handleEscolherFoto = (url) => {
    setFormData(prev => ({ ...prev, foto: url }));
    setPreviewFoto(url);
    fecharModalFotos();
  };

  const validarStep1 = async () => {
    const erros = {};
    let valido = true;

    if (!formData.email) {
      erros.email = 'Email é obrigatório';
      valido = false;
    } else {
      try {
        const res = await checkEmail(formData.email);
        if (!res.data.available) {
          erros.email = 'Este email já está em uso';
          valido = false;
        }
      } catch {
        erros.email = 'Erro ao verificar email';
        valido = false;
      }
    }

    if (!formData.senha) {
      erros.senha = 'Senha é obrigatória';
      valido = false;
    }

    if (formData.senha !== formData.confirmarSenha) {
      erros.confirmarSenha = 'As senhas não coincidem';
      valido = false;
    }

    setCampoErros(erros);
    return valido;
  };

  const validarStep2 = async () => {
    const erros = {};
    let valido = true;

    if (formData.pronomes.length === 0) {
      erros.pronomes = 'Selecione pelo menos um pronome';
      valido = false;
    }

    if (formData.nametag) {
      try {
        const res = await checkNametag(formData.nametag);
        if (!res.data.available) {
          erros.nametag = 'Esta nametag já está em uso';
          valido = false;
        }
      } catch {
        erros.nametag = 'Erro ao verificar nametag';
        valido = false;
      }
    }

    setCampoErros(erros);
    return valido;
  };

  const handleNext = async () => {
    if (step === 1) {
      const ok = await validarStep1();
      if (ok) setStep(2);
    }
  };

  const handlePrev = () => {
    if (step > 1) setStep(step - 1);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setMensagem('');
    setErro('');

    const ok = await validarStep2();
    if (!ok) return;

    try {
      // Envia o objeto JSON diretamente
      const res = await createUser(formData);

      setMensagem(`Usuário cadastrado com sucesso!`);

      setFormData({
        apelido: '',
        email: '',
        senha: '',
        confirmarSenha: '',
        tipo: 'usuario',
        status: 'ativo',
        foto: '/nenhuma.png',
        nametag: '',
        bio: '',
        pronomes: []
      });

      setPreviewFoto('/nenhuma.png');
      setStep(1);
      fecharModalFotos();
    } catch (error) {
      setErro(error.message || 'Erro ao cadastrar usuário');
    }
  };

  return (
    <div className="cadastro-container">
      <h1 className='Titulo'>Cadastro de Usuário</h1>

      {mensagem && <div className="mensagem sucesso">{mensagem}</div>}
      {erro && <div className="mensagem erro">{erro}</div>}

      <form onSubmit={handleSubmit}>
        {step === 1 && (
          <div className="wizard-step">
            <div className="form-group">
              <label>Email*</label>
              <input
                type="email"
                name="email"
                value={formData.email}
                onChange={handleChange}
                className={campoErros.email ? 'erro-input' : ''}
              />
              {campoErros.email && <span className="erro-text">{campoErros.email}</span>}
            </div>

            <div className="form-group">
              <label>Senha*</label>
              <input
                type="password"
                name="senha"
                value={formData.senha}
                onChange={handleChange}
                className={campoErros.senha ? 'erro-input' : ''}
              />
              {campoErros.senha && <span className="erro-text">{campoErros.senha}</span>}
            </div>

            <div className="form-group">
              <label>Confirmar Senha*</label>
              <input
                type="password"
                name="confirmarSenha"
                value={formData.confirmarSenha}
                onChange={handleChange}
                className={campoErros.confirmarSenha ? 'erro-input' : ''}
              />
              {campoErros.confirmarSenha && <span className="erro-text">{campoErros.confirmarSenha}</span>}
            </div>

            <div className="form-buttons btn1">
              <button type="button" className="btn-primary " onClick={handleNext}>
                Próximo
              </button>
            </div>
          </div>
        )}

        {step === 2 && (
          <div className="wizard-step">
            <div className="form-group">
              <label>Foto de Perfil (clique para escolher)</label>
              <div className="foto-preview-container" onClick={abrirModalFotos}>
                <img
                  src={previewFoto || '/nenhuma.png'}
                  alt="Pré-visualização"
                  className="foto-preview"
                />
              </div>

              {showModalFotos && (
                <div className="modal-fotos-overlay" onClick={fecharModalFotos}>
                  <div className="modal-fotos-content" onClick={e => e.stopPropagation()}>
                    <h3>Escolha sua foto</h3>
                    <div className="fotos-grid">
                      {fotosPreDefinidas.map((foto, i) => (
                        <img
                          key={i}
                          src={foto}
                          alt={`Foto ${i + 1}`}
                          className="foto-opcao"
                          onClick={() => handleEscolherFoto(foto)}
                        />
                      ))}
                    </div>
                    <button className="btn-secondary" onClick={fecharModalFotos}>Cancelar</button>
                  </div>
                </div>
              )}
            </div>

            <div className="form-group">
              <label>Apelido</label>
              <input
                type="text"
                name="apelido"
                req
                value={formData.apelido}
                onChange={handleChange}
              />
            </div>

            <div className="form-group">
              <label>Nametag</label>
              <input
                type="text"
                name="nametag"
                value={formData.nametag}
                onChange={handleChange}
                required
                className={campoErros.nametag ? 'erro-input' : ''}
              />
              {campoErros.nametag && <span className="erro-text">{campoErros.nametag}</span>}
            </div>

            <div className="form-group">
              <label>Pronomes*</label>
              <div className="inline-group">
                <select
                  value={pronomeInput}
                  onChange={handlePronomeSelect}
                  className={campoErros.pronomes ? 'erro-input' : ''}
                >
                  <option value="">Selecione um pronome</option>
                  {pronomesOptions.map((option, index) => (
                    <option key={index} value={option}>
                      {option}
                    </option>
                  ))}
                </select>
                <button type="button" className="btn-secondary" onClick={handleAddPronome} disabled={!pronomeInput}>
                  Adicionar
                </button>
              </div>
              {campoErros.pronomes && <span className="erro-text">{campoErros.pronomes}</span>}

              {formData.pronomes.length > 0 && (
                <div className="tag-list">
                  {formData.pronomes.map((p, i) => (
                    <span key={i} className="tag">
                      {p}{' '}
                      <button type="button" className="btn-alert" onClick={() => handleRemovePronome(p)}>
                        ×
                      </button>
                    </span>
                  ))}
                </div>
              )}
            </div>

            <div className="form-buttons">
              <button type="button" className="btn-secondary" onClick={handlePrev}>
                Voltar
              </button>
              <button type="submit" className="btn-primary">
                Cadastrar
              </button>
            </div>
          </div>
        )}
      </form>
    </div>
  );
};

export default CadastroUsuario;
